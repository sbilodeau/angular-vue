{"version":3,"file":"angular-vue.js","sources":["../src/directives/vue.js","../src/index.js"],"sourcesContent":["import _ from \"lodash\"\n\nexport default [function() {\n    return {\n        restrict: 'A',\n        terminal: true,//any directive with lower priority will be ignored\n        priority: 1001,// 1 more than ngNonBindable => disable angular interpolation!\n        link: function(scope, element, attrs) {\n\n            const ngDelegates             = loadExposedDelegates (attrs)\n            const ngProperties            = loadExposedProperties(attrs)\n            const syncedPropertiesMapping = loadSyncedPropertiesMapping(attrs)\n\n            // test declarations\n\n            ngProperties.forEach((prop) => testDefined(scope, prop));\n            ngDelegates .forEach((prop) => testDefined(scope, prop));\n\n            const vueData = ngProperties.filter(isRootPath).reduce((data, ngProp) => {\n                const vueProp = ngProp;\n                data[vueProp] = scope.$eval(ngProp); // set initial value\n                return data\n            }, {});\n\n            const vueMethods = ngDelegates.reduce((methods, ngDelegate) => {\n                methods[ngDelegate] = function() { \n                    console.log(`Calling ng delegate: ${ngDelegate}()`)\n                    scope.$apply(()=>scope.$eval(ngDelegate).apply(scope, arguments));\n                }\n                return methods\n            }, {});\n\n            //Create root component;\n\n            var vm = new Vue({\n                components : scope.$vueComponents,\n                data: vueData,\n                methods : vueMethods,\n            }).$mount(element[0]);\n\n            // Watch changes \n\n            for(const prop of ngProperties) {\n\n                const ngProp  = prop\n                const vueProp = prop;\n\n                scope.$watch(ngProp, function(value) { \n                    console.log(`ng(${ngProp}) => vue(${vueProp}) =`, value);\n\n                    let target = vm;\n                    let prop   = vueProp;\n\n                    if(!isRootPath(prop)) {\n                        target = _.get(vm, parentPath(prop));\n                        prop   = leafPath(prop);\n                    }\n\n                    Vue.set(target, prop, value); \n                });\n            }\n\n            for(const vueProp in syncedPropertiesMapping) { // .sync\n                const ngProp = syncedPropertiesMapping[vueProp];\n\n                vm.$children.forEach(c=>c.$on(`update:${vueProp}`, (value) => {\n                    console.log(`vue(${vueProp}) => ng(${ngProp}) =`, value);\n                    scope.$apply(()=>_.set(scope, ngProp, value));\n                }));\n            }\n        }\n    };\n\n    function loadExposedProperties(attrs) {\n\n        const vDirectives = /^(?:v-model|v-html|v-text|v-show|v-class|v-attr|v-style|v-if)(?:\\.[a-z0-9]+)*$/i;\n        const vBind       = /^(?:v-bind)?:[a-z\\-]+(\\.[a-z]+)*$/i;\n        const vBindValue  = /^[a-z\\$_][a-z0-9\\$_]*(\\.[a-z\\$_][a-z0-9\\$_]*)*$/i;\n\n        const properties = (attrs.vueExpose??\"\").split(',').map(o => o.trim()).filter(o => vBindValue.test(o) );\n\n        // autodetect simple binding on props detect \n\n        const attributes = remapAttributes(attrs);\n\n        for(const name in attributes) {\n            const value = attributes[name];\n\n            const validName =  vBind      .test(name)\n                            || vDirectives.test(name);\n\n            if(validName && vBindValue.test(value)) {\n                properties.push(value);\n            }\n        }\n\n        // Add parent properties\n\n        var i = properties.length;\n\n        while(i--) {\n\n            var path = parentPath(properties[i])\n\n            while(path) {\n                properties.push(path);\n                path = parentPath(path)\n            }\n        }\n\n        return _.uniq(properties);\n    }\n\n    function loadSyncedPropertiesMapping(attrs) {\n\n        // autodetect simple binding on props detect \n\n        const vModel      = /^(?:v-model)$/i;\n        const vBind       = /^(?:v-bind)?:([a-z\\-]+)\\.sync*$/i;\n        const vBindValue  = /^[a-z\\$_][a-z0-9\\$_]*(\\.[a-z\\$_][a-z0-9\\$_]*)*$/i;\n\n        const mapping = {};\n        const attributes = remapAttributes(attrs);\n\n        for(const name in attributes) {\n            const value = attributes[name];\n\n            if(vModel.test(name)) {\n\n                const vueProp = 'value';\n\n                if(!vBindValue.test(value)) \n                    throw Error(`Unsupported v-model binding value: ${value}`);\n\n                    mapping[vueProp] = value;\n            }\n\n            if(vBind.test(name)) {\n\n                const vueProp = name.replace(vBind, \"$1\") // Keep only property name\n                                    .replace(/-[a-z]/g, (m)=>m[1].toUpperCase()).replace(/^[A-Z]/, (m)=>m[1].toLowerCase()) // convert to camel-case\n\n                if(!vBindValue.test(value)) \n                    throw Error(`Unsupported v-bind:${vueProp}.sync binding value: ${value}`);\n\n                    mapping[vueProp] = value;\n            }\n        }\n\n        return mapping;\n    }            \n\n    function loadExposedDelegates(attrs) {\n\n        const ngVueDeclaredRe = /^&([a-z\\$_][a-z0-9\\$_]*)$/i;\n        const ngDelegates     = (attrs.vueExpose??\"\")\n            .split(',')\n            .map(o=>o.trim())\n            .filter(o=>ngVueDeclaredRe.test(o))\n            .map(o=>o.replace(ngVueDeclaredRe,\"$1\"));\n\n        // autodetect simple delegate call with empty ()\n        // eg: call_function()\n\n        const vOnRe         = /^(?:v-on:|@)[a-z\\-]+(\\:[a-z0-9-]+)?(\\.[a-z0-9-]+)*/i;\n        const vOnDelegateRe = /^([a-z_$][a-z0-9_$]*)(?:\\(\\))?$/i;\n\n        for(var key in attrs.$attr) {\n            const name  = attrs.$attr[key];\n            const value = attrs[key];\n\n            const validName = vOnRe.test(name)\n\n            if(validName && vOnDelegateRe.test(value)) {\n                ngDelegates.push(value.replace(vOnDelegateRe, \"$1\"));\n            }\n        }\n\n        return ngDelegates;\n    }\n\n    function parentPath(path) {\n        const parts = path.split('.');\n        parts.pop();\n        return parts.join('.');\n    }\n\n    function leafPath(path) {\n        const parts = path.split('.');\n        return parts.pop();\n    }\n\n    function isRootPath(path) {\n        const parts = path.split('.');\n        return parts.length==1;\n    }\n\n    function remapAttributes(attrs) {\n\n        const attributes = {}\n\n        for(var key in attrs.$attr) {\n            const name  = attrs.$attr[key];\n            const value = attrs[key];\n\n\n            attributes[name] = value;\n        }\n\n        return attributes;\n\n    }\n\n    function testDefined(scope, expression) {\n        if(scope.$eval(expression)===undefined) {\n            throw Error(`\"${expression}\" is not defined on parent scope`);\n        }\n    }\n\n}]","import vueDirectiveDefinition from \"./directives/vue\";\n\nangular.module(\"angularVue\",[])\n       .directive(\"vue\", vueDirectiveDefinition);\n"],"names":["restrict","terminal","priority","link","scope","element","attrs","ngDelegates","loadExposedDelegates","ngProperties","loadExposedProperties","syncedPropertiesMapping","loadSyncedPropertiesMapping","forEach","prop","testDefined","vueData","filter","isRootPath","reduce","data","ngProp","vueProp","$eval","vueMethods","methods","ngDelegate","console","log","$apply","apply","arguments","vm","Vue","components","$vueComponents","$mount","$watch","value","target","_","get","parentPath","leafPath","set","$children","c","$on","vDirectives","vBind","vBindValue","properties","vueExpose","split","map","o","trim","test","attributes","remapAttributes","name","validName","push","i","length","path","uniq","vModel","mapping","Error","replace","m","toUpperCase","toLowerCase","ngVueDeclaredRe","vOnRe","vOnDelegateRe","key","$attr","parts","pop","join","expression","undefined","angular","module","directive","vueDirectiveDefinition"],"mappings":"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"}