{"version":3,"file":"angular-vue.min.js","sources":["../src/directives/vue.js","../src/index.js"],"sourcesContent":["import _ from \"lodash\"\n\nexport default [function() {\n    return {\n        restrict: 'A',\n        terminal: true,//any directive with lower priority will be ignored\n        priority: 1001,// 1 more than ngNonBindable => disable angular interpolation!\n        link: function(scope, element, attrs) {\n\n            const ngDelegates             = loadExposedDelegates (attrs)\n            const ngProperties            = loadExposedProperties(attrs)\n            const syncedPropertiesMapping = loadSyncedPropertiesMapping(attrs)\n\n            // test declarations\n\n            ngProperties.forEach((prop) => testDefined(scope, prop));\n            ngDelegates .forEach((prop) => testDefined(scope, prop));\n\n            const vueData = ngProperties.filter(isRootPath).reduce((data, ngProp) => {\n                const vueProp = ngProp;\n                data[vueProp] = scope.$eval(ngProp); // set initial value\n                return data\n            }, {});\n\n            const vueMethods = ngDelegates.reduce((methods, ngDelegate) => {\n                methods[ngDelegate] = function() { \n                    console.log(`Calling ng delegate: ${ngDelegate}()`)\n                    scope.$apply(()=>scope.$eval(ngDelegate).apply(scope, arguments));\n                }\n                return methods\n            }, {});\n\n            //Create root component;\n\n            var vm = new Vue({\n                components : scope.$vueComponents,\n                data: vueData,\n                methods : vueMethods,\n            }).$mount(element[0]);\n\n            // Watch changes \n\n            for(const prop of ngProperties) {\n\n                const ngProp  = prop\n                const vueProp = prop;\n\n                scope.$watch(ngProp, function(value) { \n                    console.log(`ng(${ngProp}) => vue(${vueProp}) =`, value);\n\n                    let target = vm;\n                    let prop   = vueProp;\n\n                    if(!isRootPath(prop)) {\n                        target = _.get(vm, parentPath(prop));\n                        prop   = leafPath(prop);\n                    }\n\n                    Vue.set(target, prop, value); \n                });\n            }\n\n            for(const vueProp in syncedPropertiesMapping) { // .sync\n                const ngProp = syncedPropertiesMapping[vueProp];\n\n                vm.$children.forEach(c=>c.$on(`update:${vueProp}`, (value) => {\n                    console.log(`vue(${vueProp}) => ng(${ngProp}) =`, value);\n                    scope.$apply(()=>_.set(scope, ngProp, value));\n                }));\n            }\n        }\n    };\n\n    function loadExposedProperties(attrs) {\n\n        const vDirectives = /^(?:v-model|v-html|v-text|v-show|v-class|v-attr|v-style|v-if)(?:\\.[a-z0-9]+)*$/i;\n        const vBind       = /^(?:v-bind)?:[a-z\\-]+(\\.[a-z]+)*$/i;\n        const vBindValue  = /^[a-z\\$_][a-z0-9\\$_]*(\\.[a-z\\$_][a-z0-9\\$_]*)*$/i;\n\n        const properties = (attrs.vueExpose??\"\").split(',').map(o => o.trim()).filter(o => vBindValue.test(o) );\n\n        // autodetect simple binding on props detect \n\n        const attributes = remapAttributes(attrs);\n\n        for(const name in attributes) {\n            const value = attributes[name];\n\n            const validName =  vBind      .test(name)\n                            || vDirectives.test(name);\n\n            if(validName && vBindValue.test(value)) {\n                properties.push(value);\n            }\n        }\n\n        // Add parent properties\n\n        var i = properties.length;\n\n        while(i--) {\n\n            var path = parentPath(properties[i])\n\n            while(path) {\n                properties.push(path);\n                path = parentPath(path)\n            }\n        }\n\n        return _.uniq(properties);\n    }\n\n    function loadSyncedPropertiesMapping(attrs) {\n\n        // autodetect simple binding on props detect \n\n        const vModel      = /^(?:v-model)$/i;\n        const vBind       = /^(?:v-bind)?:([a-z\\-]+)\\.sync*$/i;\n        const vBindValue  = /^[a-z\\$_][a-z0-9\\$_]*(\\.[a-z\\$_][a-z0-9\\$_]*)*$/i;\n\n        const mapping = {};\n        const attributes = remapAttributes(attrs);\n\n        for(const name in attributes) {\n            const value = attributes[name];\n\n            if(vModel.test(name)) {\n\n                const vueProp = 'value';\n\n                if(!vBindValue.test(value)) \n                    throw Error(`Unsupported v-model binding value: ${value}`);\n\n                    mapping[vueProp] = value;\n            }\n\n            if(vBind.test(name)) {\n\n                const vueProp = name.replace(vBind, \"$1\") // Keep only property name\n                                    .replace(/-[a-z]/g, (m)=>m[1].toUpperCase()).replace(/^[A-Z]/, (m)=>m[1].toLowerCase()) // convert to camel-case\n\n                if(!vBindValue.test(value)) \n                    throw Error(`Unsupported v-bind:${vueProp}.sync binding value: ${value}`);\n\n                    mapping[vueProp] = value;\n            }\n        }\n\n        return mapping;\n    }            \n\n    function loadExposedDelegates(attrs) {\n\n        const ngVueDeclaredRe = /^&([a-z\\$_][a-z0-9\\$_]*)$/i;\n        const ngDelegates     = (attrs.vueExpose??\"\")\n            .split(',')\n            .map(o=>o.trim())\n            .filter(o=>ngVueDeclaredRe.test(o))\n            .map(o=>o.replace(ngVueDeclaredRe,\"$1\"));\n\n        // autodetect simple delegate call with empty ()\n        // eg: call_function()\n\n        const vOnRe         = /^(?:v-on:|@)[a-z\\-]+(\\:[a-z0-9-]+)?(\\.[a-z0-9-]+)*/i;\n        const vOnDelegateRe = /^([a-z_$][a-z0-9_$]*)(?:\\(\\))?$/i;\n\n        for(var key in attrs.$attr) {\n            const name  = attrs.$attr[key];\n            const value = attrs[key];\n\n            const validName = vOnRe.test(name)\n\n            if(validName && vOnDelegateRe.test(value)) {\n                ngDelegates.push(value.replace(vOnDelegateRe, \"$1\"));\n            }\n        }\n\n        return ngDelegates;\n    }\n\n    function parentPath(path) {\n        const parts = path.split('.');\n        parts.pop();\n        return parts.join('.');\n    }\n\n    function leafPath(path) {\n        const parts = path.split('.');\n        return parts.pop();\n    }\n\n    function isRootPath(path) {\n        const parts = path.split('.');\n        return parts.length==1;\n    }\n\n    function remapAttributes(attrs) {\n\n        const attributes = {}\n\n        for(var key in attrs.$attr) {\n            const name  = attrs.$attr[key];\n            const value = attrs[key];\n\n\n            attributes[name] = value;\n        }\n\n        return attributes;\n\n    }\n\n    function testDefined(scope, expression) {\n        if(scope.$eval(expression)===undefined) {\n            throw Error(`\"${expression}\" is not defined on parent scope`);\n        }\n    }\n\n}]","import vueDirectiveDefinition from \"./directives/vue\";\n\nangular.module(\"angularVue\",[])\n       .directive(\"vue\", vueDirectiveDefinition);\n"],"names":["restrict","terminal","priority","link","scope","element","attrs","ngDelegates","ngVueDeclaredRe","vueExpose","split","map","o","trim","filter","test","replace","vOnRe","vOnDelegateRe","key","$attr","name","value","push","loadExposedDelegates","ngProperties","vDirectives","vBind","vBindValue","properties","attributes","remapAttributes","i","length","path","parentPath","_","uniq","loadExposedProperties","syncedPropertiesMapping","vModel","mapping","vueProp","Error","m","toUpperCase","toLowerCase","loadSyncedPropertiesMapping","forEach","prop","testDefined","vueData","isRootPath","reduce","data","ngProp","$eval","vueMethods","methods","ngDelegate","console","log","$apply","apply","arguments","vm","Vue","components","$vueComponents","$mount","$watch","target","get","pop","set","$children","c","$on","parts","join","expression","undefined","angular","module","directive","vueDirectiveDefinition"],"mappings":"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"}