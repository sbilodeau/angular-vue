{"version":3,"file":"angular-vue.min.js","sources":["../src/libs/paths.js","../src/directives/vue.js","../src/index.js"],"sourcesContent":["export default {\n    parent,\n    parents,\n    leaf,\n    root,\n    isRoot\n};\n\nfunction parent(path) {\n    const parts = split(path)\n\n    parts.pop();\n\n    return combine(parts)\n}\n\nfunction parents(path) {\n    const parentPaths = [];\n\n    path = parent(path)\n\n    while(path) {\n        parentPaths.push(path);\n        path = parent(path)\n    }\n\n    return parentPaths;\n}\n\nfunction leaf(path) {\n    const parts = split(path);\n    return parts.pop();\n}\n\nfunction root(path) {\n    return split(path)[0];\n}\n\nfunction isRoot(path) {\n    return split(path).length==1;\n}\n\nfunction split(path) {\n\n    if(!path) throw new Error(`Invalid path ${path}`);\n\n    return path.split('.');\n}\n\nfunction combine(parts) {\n    return parts.join('.');\n}\n\n\n\n\n","import _ from \"lodash\"\nimport Vue from \"Vue\"\nimport paths from \"../libs/paths\"\n\nexport default { register };\n\nfunction register(ngModule) { ngModule.directive('vue', [function() {\n    return {\n        restrict: 'A',\n        terminal: true,//any directive with lower priority will be ignored\n        priority: 1001,// 1 more than ngNonBindable => disable angular interpolation!\n        link: function(scope, element, attrs) {\n\n            const ngDelegates             = loadExposedDelegates (attrs)\n            const ngProperties            = loadExposedProperties(attrs)\n            const syncedPropertiesMapping = loadSyncedPropertiesMapping(attrs)\n\n            // test declarations\n\n            ngProperties.forEach((prop) => testDefined(scope, prop));\n            ngDelegates .forEach((prop) => testDefined(scope, prop));\n\n            const vueData = ngProperties.filter(paths.isRoot).reduce((data, ngProp) => {\n                const vueProp = ngProp;\n                data[vueProp] = scope.$eval(ngProp); // set initial value\n                return data\n            }, {});\n\n            const vueMethods = ngDelegates.reduce((methods, ngDelegate) => {\n                methods[ngDelegate] = function() { \n                    console.log(`Calling ng delegate: ${ngDelegate}()`)\n                    scope.$apply(()=>scope.$eval(ngDelegate).apply(scope, arguments));\n                }\n                return methods\n            }, {});\n\n            //Create root component;\n\n            var vm = new Vue({\n                components : scope.$vueComponents,\n                data: vueData,\n                methods : vueMethods,\n            }).$mount(element[0]);\n\n            // Watch changes \n\n            for(const prop of ngProperties) {\n\n                const ngProp  = prop\n                const vueProp = prop;\n\n                scope.$watch(ngProp, function(value) { \n                    console.log(`ng(${ngProp}) => vue(${vueProp}) =`, value);\n\n                    let target = vm;\n                    let prop   = vueProp;\n\n                    if(!paths.isRoot(prop)) {\n                        target = _.get(vm, paths.parent(prop));\n                        prop   = paths.leaf(prop);\n                    }\n\n                    Vue.set(target, prop, value); \n                });\n            }\n\n            for(const vueProp in syncedPropertiesMapping) { // .sync\n                const ngProp = syncedPropertiesMapping[vueProp];\n\n                vm.$children.forEach(c=>c.$on(`update:${vueProp}`, (value) => {\n                    console.log(`vue(${vueProp}) => ng(${ngProp}) =`, value);\n                    scope.$apply(()=>_.set(scope, ngProp, value));\n                }));\n            }\n        }\n    };\n\n    function loadExposedProperties(attrs) {\n\n        const vDirectives = /^(?:v-model|v-html|v-text|v-show|v-class|v-attr|v-style|v-if)(?:\\.[a-z0-9]+)*$/i;\n        const vBind       = /^(?:v-bind)?:[a-z\\-]+(\\.[a-z]+)*$/i;\n        const vBindValue  = /^[a-z\\$_][a-z0-9\\$_]*(\\.[a-z\\$_][a-z0-9\\$_]*)*$/i;\n\n        let properties = (attrs.vueExpose??\"\").split(',').map(o => o.trim()).filter(o => vBindValue.test(o) );\n\n        // autodetect simple binding on props detect \n\n        const attributes = remapAttributes(attrs);\n\n        for(const name in attributes) {\n            const value = attributes[name];\n\n            const validName =  vBind      .test(name)\n                            || vDirectives.test(name);\n\n            if(validName && vBindValue.test(value)) {\n                properties.push(value);\n            }\n        }\n\n        // Add parent properties\n\n        properties.forEach(prop => {\n            properties = _.union(properties, paths.parents(prop));\n        })\n\n        return _(properties).uniq().sort();\n    }\n\n    function loadSyncedPropertiesMapping(attrs) {\n\n        // autodetect simple binding on props detect \n\n        const vModel      = /^(?:v-model)$/i;\n        const vBind       = /^(?:v-bind)?:([a-z\\-]+)\\.sync*$/i;\n        const vBindValue  = /^[a-z\\$_][a-z0-9\\$_]*(\\.[a-z\\$_][a-z0-9\\$_]*)*$/i;\n\n        const mapping = {};\n        const attributes = remapAttributes(attrs);\n\n        for(const name in attributes) {\n            const value = attributes[name];\n\n            if(vModel.test(name)) {\n\n                const vueProp = 'value';\n\n                if(!vBindValue.test(value)) \n                    throw Error(`Unsupported v-model binding value: ${value}`);\n\n                    mapping[vueProp] = value;\n            }\n\n            if(vBind.test(name)) {\n\n                const vueProp = name.replace(vBind, \"$1\") // Keep only property name\n                                    .replace(/-[a-z]/g, (m)=>m[1].toUpperCase()).replace(/^[A-Z]/, (m)=>m[1].toLowerCase()) // convert to camel-case\n\n                if(!vBindValue.test(value)) \n                    throw Error(`Unsupported v-bind:${vueProp}.sync binding value: ${value}`);\n\n                    mapping[vueProp] = value;\n            }\n        }\n\n        return mapping;\n    }            \n\n    function loadExposedDelegates(attrs) {\n\n        const ngVueDeclaredRe = /^&([a-z\\$_][a-z0-9\\$_]*)$/i;\n        const ngDelegates     = (attrs.vueExpose??\"\")\n            .split(',')\n            .map(o=>o.trim())\n            .filter(o=>ngVueDeclaredRe.test(o))\n            .map(o=>o.replace(ngVueDeclaredRe,\"$1\"));\n\n        // autodetect simple delegate call with empty ()\n        // eg: call_function()\n\n        const vOnRe         = /^(?:v-on:|@)[a-z\\-]+(\\:[a-z0-9-]+)?(\\.[a-z0-9-]+)*/i;\n        const vOnDelegateRe = /^([a-z_$][a-z0-9_$]*)(?:\\(\\))?$/i;\n\n        for(var key in attrs.$attr) {\n            const name  = attrs.$attr[key];\n            const value = attrs[key];\n\n            const validName = vOnRe.test(name)\n\n            if(validName && vOnDelegateRe.test(value)) {\n                ngDelegates.push(value.replace(vOnDelegateRe, \"$1\"));\n            }\n        }\n\n        return ngDelegates;\n    }\n\n\n    function remapAttributes(attrs) {\n\n        const attributes = {}\n\n        for(var key in attrs.$attr) {\n            const name  = attrs.$attr[key];\n            const value = attrs[key];\n\n\n            attributes[name] = value;\n        }\n\n        return attributes;\n\n    }\n\n    function testDefined(scope, expression) {\n        if(scope.$eval(expression)===undefined) {\n            throw Error(`\"${expression}\" is not defined on parent scope`);\n        }\n    }\n\n}])};","import angular from \"angular\";\nimport vueDirective from \"./directives/vue\";\n\nvar ngModule = angular.module(\"angularVue\",[]);\n\nvueDirective.register(ngModule);\n"],"names":["parent","parents","path","parentPaths","push","leaf","split","pop","root","isRoot","length","parts","join","combine","Error","register","ngModule","directive","restrict","terminal","priority","link","scope","element","attrs","ngDelegates","ngVueDeclaredRe","vueExpose","map","o","trim","filter","test","replace","vOnRe","vOnDelegateRe","key","$attr","name","value","loadExposedDelegates","ngProperties","vDirectives","vBind","vBindValue","properties","attributes","remapAttributes","forEach","prop","_","union","paths","uniq","sort","loadExposedProperties","syncedPropertiesMapping","vModel","mapping","vueProp","m","toUpperCase","toLowerCase","loadSyncedPropertiesMapping","testDefined","vueData","reduce","data","ngProp","$eval","vueMethods","methods","ngDelegate","console","log","$apply","apply","arguments","vm","Vue","components","$vueComponents","$mount","$watch","target","get","set","$children","c","$on","expression","undefined","angular","module","vueDirective"],"mappings":"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"}